# Задание для школы бэкэнд-разработки Yandex

 * [Описание задания](#decription)
 * [Реализованные обработчики REST API](#handlers)
   * [1: POST /couriers](#post-couriers)
   * [2: PATCH /couriers/$courier_id](#patch-courier)
   * [3: POST /orders](#post-orders)
   * [4: POST /orders/assign](#post-orders-assign)
   * [5: POST /orders/complete](#post-orders-complete)
   * [6: GET /couriers/$courier_id](#get-courierid)
 * [Инструкции](#guides)
   * [Запуск приложения](#launch-app)
   * [Запуск тестов](#launch-tests)

## <a name="decription"></a> Описание задания
Чтобы немного скрасить жизнь людей на самоизоляции, вы решаете открыть
интернет-магазин по доставке конфет "Сласти от всех напастей".

Ваша задача — разработать на python REST API сервис, который позволит нанимать курьеров на работу,
принимать заказы и оптимально распределять заказы между курьерами, попутно считая их рейтинг и заработок.

Сервис необходимо развернуть на предоставленной виртуальной машине на
0.0.0.0:8080.

## <a name="handlers"></a> Реализованные обработчики REST API
### <a name="post-couriers"></a> 1: POST /couriers
Обработчик принимает на вход в формате `json` список с данными о курьерах и графиком их работы.
Курьеры работают только в заранее определенных районах,
а так же различаются по типу: пеший, велокурьер и курьер на автомобиле. От типа курьера
зависит его грузоподъемность — 10 кг, 15 кг и 50 кг соответственно.
Районы задаются целыми положительными числами. График работы задается списком строк формата `HH:MM-HH:MM` .

Пример запроса:
```json
POST /couriers
{
    "data": [
    {
        "courier_id": 1,
        "courier_type": "foot",
        "regions": [1, 12, 22],
        "working_hours": ["11:35-14:05", "09:00-11:00"]
    },
    {
        "courier_id": 2,
        "courier_type": "bike",
        "regions": [22],
        "working_hours": ["09:00-18:00"]
    },
    {
        "courier_id": 3,
        "courier_type": "car",
        "regions": [12, 22, 23, 33],
        "working_hours": []
    },
    ...
  ]
}
```

Поле  |Тип  | Значение
------------- | ------------- | -------------
courier_id | Целое положительное число | Уникальный идентификатор курьера, положительное число.<br>Идентификаторы уникальны в пределах всего сервиса.
courier_type | Строка | Тип курьера. Возможные значения:<br>`foot` — пеший курьер<br>`bike` — велокурьер<br>`car` — курьер на автомобиле
regions | Массив целых положительных чисел | Список идентификаторов районов, в которых работает курьер.
working_hours | Массив строк | График работы курьера. Формат строки  `HH:MM-HH:MM` . Есть гарантия на то, что промежутки, переданные тестирующей системой, не будут пересекаться.

Все поля обязательны.

В случае, если в наборе есть неописанные поля или какие-либо из полей отсутствуют — следует вернуть ошибку  `HTTP
400 Bad Request`  и список id, которые не удалось провалидировать.

```json
HTTP 400 Bad Request
{
    "validation_error": {
        "couriers": [{"id": 2}, {"id": 3}]
    }
}
```

В случае успеха — вернуть ответ  `HTTP 201 Created`  и списком импортированных id.

```json
HTTP 201 Created
{
    "couriers": [{"id": 1}, {"id": 2}, {"id": 3}]
}
```

### <a name="patch-couriers"></a> 2: PATCH /couriers/$courier_id
Позволяет изменить информацию о курьере. Принимает  json  и любые поля из списка:  `courier_type` ,  `regions` ,  `working_hours` .
При редактировании следует учесть случаи, когда меняется график и уменьшается грузоподъемность и появляются
заказы,
которые курьер уже не сможет развести — такие заказы должны сниматься и быть доступными для выдачи другим
курьерам.

```json
PATCH /couriers/2
{
    "regions": [11, 33, 2]
}
```
В случае, если передано неописанное поле — вернуть  `HTTP 400 Bad Request` .

В случае успеха —  `HTTP 200 OK`  и актуальную информацию о редактируемом курьере.

```json
HTTP 200 OK
{
    "courier_id": 2,
    "courier_type": "foot",
    "regions": [11, 33, 2],
    "working_hours": ["09:00-18:00"]
}
```

### <a name="post-orders"></a> 3: POST /orders
Принимает на вход в формате  `json`  список с данными о заказах. Заказы характеризуются весом, районом и временем доставки.

Пример запроса:
```json
POST /orders
{
    "data": [
    {
        "order_id": 1,
        "weight": 0.23,
        "region": 12,
        "delivery_hours": ["09:00-18:00"]
    },
    {
        "order_id": 2,
        "weight": 15,
        "region": 1,
        "delivery_hours": ["09:00-18:00"]
    },
    {
        "order_id": 3,
        "weight": 0.01,
        "region": 22,
        "delivery_hours": ["09:00-12:00", "16:00-21:30"]
    },
    ...
  ]
}
```

Поле  |Тип  | Значение
------------- | ------------- | -------------
order_id | Целое положительное число | id заказа, уникален в пределах всех заказов сервиса.
weight | Положительное число с плавающей точкой | Вес заказа в кг. 2 значащих разряда после запятой.<br>Значения меньше 0.01 и больше 50 считать невалидными.
region | Целое положительное число | Район доставки заказа.
delivery_hours | Массив строк | Промежутки, в которые клиенту удобно принять заказ. Формат строки  `HH:MM-HH:MM`. Есть гарантия на то, что промежутки, переданные тестирующей системой, не будут пересекаться.

В случае, если в наборе есть неописанные поля или какие-либо из полей отсутствуют — следует вернуть ошибку  `HTTP 400 Bad Request` .

Пример ответа:
```json
HTTP 400 Bad Request
{
    "validation_error": {
        "orders": [{"id": 2}, {"id": 3}]
    }
}
```
В случае успеха —  `HTTP 201 Created`  и список импортированных id.

Пример:
```json
HTTP 201 Created
{
    "orders": [{"id": 1}, {"id": 2}, {"id": 3}]
}
```

### <a name="post-orders-assign"></a> 4: POST /orders/assigns
Принимает id курьера и назначает максимальное количество заказов, подходящих по весу, району и графику работы.

Обработчик должен быть идемпотентным. Заказы, выданные одному курьеру, не должны быть доступны для выдачи другому.

Если  `/orders/assign`  вызывается после того, как курьер уже доставил какие-то ранее выданные заказы, то такие заказы нужно убрать из ответа, а  `assign_time`  должен остаться тем же. В  `assign_time`  должно содержаться время
успешного назначения заказов.

В случае, когда не удалось найти подходящих заказов, нужно вернуть пустой список;  `assign_time`  возвращать не нужно.

Пример запроса:

```json
POST /orders/assign
{
    "courier_id": 2
}
```

Пример ответа:
```json
HTTP 200 OK
{
    "orders": [{"id": 1}, {"id": 2}],
    "assign_time": "2021-01-10T09:32:14.42Z"
}
```

В случае, если передан идентификатор несуществующего курьера, следует вернуть ошибку  `HTTP 400 Bad Request` .


### <a name="post-orders-complete"></a> 5: POST /orders/complete
Принимает 3 параметра: id курьера, id заказа и время выполнения заказа, отмечает заказ выполненным.
В случае, если заказ не найден, был назначен на другого курьера или не назначен вовсе, следует вернуть ошибку  `HTTP 400 Bad Request` .

В случае успеха — `HTTP 200 OK`  и идентификатор завершенного заказа.

Обработчик должен быть идемпотентным.

Пример запроса:
```json
POST /orders/complete
{
    "courier_id": 2,
    "order_id": 33,
    "complete_time": "2021-01-10T10:33:01.42Z"
}
```

Пример ответа:
```json
HTTP 200 OK
{
    "order_id": 33
}
```

### <a name="get-courierid"></a> 6: GET /couriers/$courier_id
Возвращает информацию о курьере и дополнительную статистику: рейтинг и заработок.

Пример ответа:
```json
GET /couriers/2
{
    "courier_id": 2,
    "courier_type": "foot",
    "regions": [11, 33, 2],
    "working_hours": ["09:00-18:00"],
    "rating": 4.93,
    "earnings": 10000
}
```

Рейтинг рассчитывается следующим образом:

`(60*60 - min(t, 60*60))/(60*60) * 5`

где `t` - минимальное из средних времен доставки по районам (в секундах),

`t = min(td[1], td[2], ..., td[n])`

`td[i]` - среднее время доставки заказов по району `i` (в секундах).

Время доставки одного заказа определяется как разница между временем окончания этого заказа и временем окончания предыдущего заказа (или временем назначения заказов, если вычисляется время для первого заказа).

Если курьер не завершил ни одного развоза, то рассчитывать и возвращать рейтинг не нужно.

Заработок рассчитывается как сумма оплаты за каждый завершенный развоз:

$sum=\sum(500 * C)$

`C` — коэффициент, зависящий от типа курьера (пеший — 2, велокурьер — 5, авто — 9) на момент формирования
развоза.

## <a name="guides"></a> Инструкции

### <a name="launch-app"></a> Запуск приложения

##### 1. Установить зависимости для python:
```python
pip install -r requirements.txt
```
##### 2. Настроить переменные окружения в файле `.env`:
```python
USERNAME="username"
DBPW="dbpassword"
DBNAME="dbname"
TEST_DB_NAME="test"
```

##### 3. Запуск приложения
```python
uvicorn main:app --host 0.0.0.0 --port 8080
```

### <a name="launch-tests"></a> Запуск тестов
```python
python -m pytest tests
```

### Запуск нагрузочного тестирования
Для запуска `locust` необходимо ввести следующую команду:
```python
locust -f locust.py --host=http://0.0.0.0:8080
```

* `--host` - отвечает за адрес и порт на котором запущено приложение для тестирования
